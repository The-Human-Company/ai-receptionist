<!DOCTYPE html>
<html lang="en" class="antialiased">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Equity Insurance | AI Command Center</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Plus+Jakarta+Sans:wght@400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Plus Jakarta Sans"', 'sans-serif'],
                        display: ['"Outfit"', 'sans-serif'],
                        mono: ['"JetBrains Mono"', 'monospace'],
                    },
                    colors: {
                        background: '#09090b',
                        surface: '#18181b',
                        surfaceHighlight: '#27272a',
                        primary: '#3b82f6',
                        primaryDark: '#1d4ed8',
                        accent: '#f59e0b',
                        success: '#10b981',
                        danger: '#ef4444',
                        border: '#27272a',
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'float': 'float 6s ease-in-out infinite',
                        'slide-up': 'slideUp 0.3s ease-out forwards',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        },
                        slideUp: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #09090b;
            background-image: 
                radial-gradient(circle at 50% 0%, rgba(59, 130, 246, 0.15), transparent 40%),
                radial-gradient(circle at 0% 100%, rgba(245, 158, 11, 0.05), transparent 40%);
            color: #e4e4e7;
        }

        /* Glassmorphism utilities */
        .glass {
            background: rgba(24, 24, 27, 0.6);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        
        .glass-panel {
            background: rgba(24, 24, 27, 0.4);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #52525b; }

        /* Visualizer Bars */
        .viz-bar {
            transition: height 0.05s ease;
            min-height: 4px;
            border-radius: 2px;
        }

        /* Status Dot Pulse */
        .status-dot-pulse {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            animation: ping 1.5s cubic-bezier(0, 0, 0.2, 1) infinite;
            opacity: 0.75;
        }
        @keyframes ping {
            75%, 100% { transform: scale(2); opacity: 0; }
        }

        /* Stage Pips */
        .stage-pip {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* Typing Indicator */
        .typing-dot {
            animation: typing 1.4s infinite ease-in-out both;
        }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden selection:bg-primary selection:text-white">

    <!-- Top Navigation -->
    <header class="h-16 border-b border-border flex items-center justify-between px-6 shrink-0 glass z-50">
        <div class="flex items-center gap-4">
            <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-primary to-primaryDark flex items-center justify-center shadow-lg shadow-primary/20">
                <i data-lucide="shield" class="w-5 h-5 text-white"></i>
            </div>
            <div>
                <h1 class="font-display font-bold text-lg leading-tight tracking-tight text-white">Equity Insurance</h1>
                <div class="flex items-center gap-2">
                    <span class="text-[10px] font-mono uppercase tracking-wider text-zinc-500">AI RECEPTIONIST</span>
                    <span class="w-1 h-1 rounded-full bg-zinc-600"></span>
                    <span class="text-[10px] font-mono text-zinc-500">VAPI.AI + N8N</span>
                </div>
            </div>
        </div>
        
        <div class="flex items-center gap-6">
            <!-- Environment Badge -->
            <div class="hidden md:flex items-center gap-2 px-3 py-1.5 rounded-full bg-surfaceHighlight border border-white/5">
                <i data-lucide="server" class="w-3 h-3 text-zinc-400"></i>
                <span class="text-xs font-medium text-zinc-300">Production</span>
            </div>

            <!-- Connection Status -->
            <div class="flex items-center gap-3 pl-6 border-l border-white/10">
                <div class="relative w-2.5 h-2.5">
                    <div id="status-ping" class="status-dot-pulse bg-zinc-500 hidden"></div>
                    <div id="status-dot" class="relative w-2.5 h-2.5 rounded-full bg-zinc-500 transition-colors duration-300"></div>
                </div>
                <span id="connection-status" class="text-xs font-semibold text-zinc-400 uppercase tracking-wide">Disconnected</span>
            </div>
        </div>
    </header>

    <!-- Main Grid -->
    <main class="flex-1 grid grid-cols-1 lg:grid-cols-12 gap-0 min-h-0 relative">
        
        <!-- LEFT: Active Call Stage (5 cols) -->
        <div class="lg:col-span-5 relative flex flex-col border-r border-border bg-surface/30">
            
            <!-- Mode Toggle -->
            <div class="absolute top-6 left-6 z-20">
                <div class="glass rounded-lg p-1 flex gap-1 shadow-xl">
                    <button onclick="setMode('business')" id="mode-biz" class="px-4 py-2 rounded-md text-xs font-semibold transition-all duration-200 bg-primary text-white shadow-lg shadow-primary/25">
                        Business Hours
                    </button>
                    <button onclick="setMode('afterhours')" id="mode-ah" class="px-4 py-2 rounded-md text-xs font-semibold transition-all duration-200 text-zinc-400 hover:text-white hover:bg-white/5">
                        After Hours
                    </button>
                </div>
            </div>

            <!-- Center Stage -->
            <div class="flex-1 flex flex-col items-center justify-center relative p-8">
                
                <!-- Ambient Glow -->
                <div id="ambient-glow" class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-64 h-64 bg-primary/20 rounded-full blur-[100px] transition-all duration-700 opacity-0"></div>

                <!-- Call Status Visuals -->
                <div class="relative z-10 flex flex-col items-center gap-8">
                    
                    <!-- Avatar / Visualizer Circle -->
                    <div class="relative">
                        <!-- Ring 1 -->
                        <div id="ring-1" class="absolute inset-0 rounded-full border border-primary/30 scale-110 opacity-0 transition-all duration-500"></div>
                        <!-- Ring 2 -->
                        <div id="ring-2" class="absolute inset-0 rounded-full border border-primary/20 scale-125 opacity-0 transition-all duration-500 delay-75"></div>
                        
                        <div class="w-40 h-40 rounded-full glass flex items-center justify-center shadow-2xl relative overflow-hidden group">
                            <div class="absolute inset-0 bg-gradient-to-b from-white/5 to-transparent opacity-50"></div>
                            <i data-lucide="mic" class="w-12 h-12 text-zinc-500 transition-colors duration-300" id="main-mic-icon"></i>
                            
                            <!-- Active Visualizer Overlay -->
                            <div id="circle-visualizer" class="absolute inset-0 flex items-center justify-center gap-1 opacity-0 transition-opacity duration-300">
                                <div class="w-1.5 h-8 bg-primary rounded-full animate-pulse"></div>
                                <div class="w-1.5 h-12 bg-primary rounded-full animate-pulse delay-75"></div>
                                <div class="w-1.5 h-6 bg-primary rounded-full animate-pulse delay-150"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Mic Level Indicator -->
                    <div id="mic-level-bar" class="w-40 h-2 rounded-full bg-zinc-800 overflow-hidden opacity-0 transition-opacity duration-300">
                        <div id="mic-level-fill" class="h-full rounded-full bg-zinc-600 transition-all duration-100" style="width: 0%"></div>
                    </div>

                    <!-- Timer & State -->
                    <div class="text-center space-y-2">
                        <div id="timer" class="font-mono text-5xl font-light tracking-tighter text-white tabular-nums">00:00</div>
                        <div id="call-state-text" class="text-sm font-medium text-zinc-500 uppercase tracking-widest">Ready to Connect</div>
                        <!-- Partial transcript — shows user's speech in real-time -->
                        <div id="partial-transcript" class="hidden text-xs text-zinc-500 italic max-w-xs truncate mt-1"></div>
                    </div>
                </div>
            </div>

            <!-- Bottom Controls -->
            <div class="p-8 pb-10 flex justify-center gap-6 relative z-20">
                <button id="callBtn" onclick="toggleCall()" class="group relative flex items-center justify-center w-16 h-16 rounded-2xl bg-white text-black hover:scale-105 transition-all duration-300 shadow-[0_0_40px_-10px_rgba(255,255,255,0.3)]">
                    <i data-lucide="phone" class="w-6 h-6 transition-transform group-hover:rotate-12"></i>
                </button>
                
                <button id="muteBtn" onclick="toggleMute()" disabled class="group flex items-center justify-center w-16 h-16 rounded-2xl glass text-zinc-400 hover:text-white hover:bg-white/10 transition-all duration-300 disabled:opacity-30 disabled:cursor-not-allowed">
                    <i data-lucide="mic" class="w-6 h-6"></i>
                </button>
                
                <button onclick="window.location.reload()" class="group flex items-center justify-center w-16 h-16 rounded-2xl glass text-zinc-400 hover:text-white hover:bg-white/10 transition-all duration-300">
                    <i data-lucide="rotate-ccw" class="w-6 h-6 transition-transform group-hover:-rotate-180"></i>
                </button>
            </div>
        </div>

        <!-- CENTER: Transcript (4 cols) -->
        <div class="lg:col-span-4 border-r border-border bg-background flex flex-col min-h-0">
            <div class="h-16 px-6 border-b border-border flex items-center justify-between bg-surface/50 backdrop-blur-sm">
                <h2 class="font-display font-semibold text-sm tracking-wide text-zinc-200 flex items-center gap-2">
                    <i data-lucide="message-square" class="w-4 h-4 text-primary"></i>
                    Live Transcript
                </h2>
                <button onclick="clearTranscript()" class="text-xs text-zinc-500 hover:text-white transition-colors">Clear</button>
            </div>

            <div id="transcript" class="flex-1 overflow-y-auto p-6 space-y-6 scroll-smooth">
                <!-- Empty State -->
                <div class="h-full flex flex-col items-center justify-center text-zinc-600 gap-4 opacity-50">
                    <i data-lucide="bot" class="w-12 h-12 stroke-1"></i>
                    <p class="text-sm font-medium">Waiting for call to start...</p>
                </div>
            </div>

            <!-- Typing Indicator -->
            <div id="typing-indicator" class="hidden px-6 py-4 border-t border-border bg-surface/30">
                <div class="flex items-center gap-3">
                    <span class="text-xs font-medium text-primary">AI is speaking</span>
                    <div class="flex gap-1">
                        <div class="w-1.5 h-1.5 bg-primary rounded-full typing-dot"></div>
                        <div class="w-1.5 h-1.5 bg-primary rounded-full typing-dot"></div>
                        <div class="w-1.5 h-1.5 bg-primary rounded-full typing-dot"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- RIGHT: Data & Logs (3 cols) -->
        <div class="lg:col-span-3 flex flex-col min-h-0 bg-surface/20">
            
            <!-- Call Stage Indicator -->
            <div class="px-4 py-3 border-b border-border bg-surface/50 backdrop-blur-sm">
                <div class="flex items-center gap-2 mb-2">
                    <i data-lucide="activity" class="w-3.5 h-3.5 text-zinc-500"></i>
                    <span class="text-[10px] font-mono font-bold text-zinc-500 uppercase tracking-wider">Call Flow</span>
                </div>
                <div id="call-stages" class="flex items-center gap-1">
                    <div class="stage-pip" data-stage="idle">
                        <div class="w-full h-1.5 rounded-full bg-zinc-700 transition-all duration-500" id="stage-idle"></div>
                        <span class="text-[9px] text-zinc-600 mt-1">Idle</span>
                    </div>
                    <div class="stage-pip" data-stage="collecting">
                        <div class="w-full h-1.5 rounded-full bg-zinc-700 transition-all duration-500" id="stage-collecting"></div>
                        <span class="text-[9px] text-zinc-600 mt-1">Collecting</span>
                    </div>
                    <div class="stage-pip" data-stage="evaluating">
                        <div class="w-full h-1.5 rounded-full bg-zinc-700 transition-all duration-500" id="stage-evaluating"></div>
                        <span class="text-[9px] text-zinc-600 mt-1">Evaluating</span>
                    </div>
                    <div class="stage-pip" data-stage="routing">
                        <div class="w-full h-1.5 rounded-full bg-zinc-700 transition-all duration-500" id="stage-routing"></div>
                        <span class="text-[9px] text-zinc-600 mt-1">Routing</span>
                    </div>
                    <div class="stage-pip" data-stage="complete">
                        <div class="w-full h-1.5 rounded-full bg-zinc-700 transition-all duration-500" id="stage-complete"></div>
                        <span class="text-[9px] text-zinc-600 mt-1">Done</span>
                    </div>
                </div>
            </div>

            <!-- Status Badges -->
            <div id="status-badges" class="px-4 py-3 border-b border-border space-y-2 hidden">
                <div id="badge-calltype" class="hidden flex items-center gap-2 px-3 py-1.5 rounded-lg bg-surface border border-white/5">
                    <i data-lucide="phone-forwarded" class="w-3.5 h-3.5"></i>
                    <span class="text-xs font-medium" id="badge-calltype-text"></span>
                </div>
                <div id="badge-disqualifier" class="hidden flex items-center gap-2 px-3 py-1.5 rounded-lg bg-surface border border-white/5">
                    <i data-lucide="shield-check" class="w-3.5 h-3.5"></i>
                    <span class="text-xs font-medium" id="badge-disqualifier-text"></span>
                </div>
                <div id="badge-hotlead" class="hidden flex items-center gap-2 px-3 py-1.5 rounded-lg bg-surface border border-white/5">
                    <i data-lucide="flame" class="w-3.5 h-3.5"></i>
                    <span class="text-xs font-medium" id="badge-hotlead-text"></span>
                </div>
            </div>

            <!-- Data Extraction Panel -->
            <div class="flex-1 flex flex-col min-h-0 border-b border-border">
                <div class="h-12 px-6 border-b border-border flex items-center justify-between bg-surface/50 backdrop-blur-sm">
                    <h2 class="font-display font-semibold text-sm tracking-wide text-zinc-200 flex items-center gap-2">
                        <i data-lucide="database" class="w-4 h-4 text-accent"></i>
                        Extracted Data
                    </h2>
                    <span id="field-count" class="text-[10px] font-mono text-zinc-600">0 / 12+</span>
                </div>

                <div class="flex-1 overflow-y-auto p-0">
                    <table class="w-full text-left border-collapse">
                        <tbody id="data-table-body" class="divide-y divide-white/5">
                            <tr class="text-zinc-600">
                                <td class="px-6 py-8 text-center text-xs italic" colspan="2">
                                    Data fields collected during the call will appear here in real-time.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- System Logs Panel -->
            <div class="h-1/3 flex flex-col bg-[#0c0c0e]">
                <div class="px-4 py-2 border-b border-white/5 flex justify-between items-center bg-white/5">
                    <span class="text-[10px] font-mono font-bold text-zinc-500 uppercase">System Logs</span>
                    <div class="flex gap-1.5">
                        <div class="w-2 h-2 rounded-full bg-zinc-700"></div>
                        <div class="w-2 h-2 rounded-full bg-zinc-700"></div>
                    </div>
                </div>
                <div id="system-logs" class="flex-1 overflow-y-auto p-4 font-mono text-[10px] leading-relaxed space-y-1.5 text-zinc-400">
                    <div class="text-zinc-500">> System initialized. Ready.</div>
                </div>
            </div>
        </div>

    </main>

    <script>
        // Initialize Icons
        lucide.createIcons();

        // ============================
        // CONFIGURATION
        // ============================
        const VAPI_PUBLIC_KEY = '7fa4969d-367a-43c3-a835-121e9a2d6c9b';

        // n8n webhook base URL
        const N8N_BASE = 'https://solarexpresss.app.n8n.cloud/webhook';

        // Shared voice, transcriber, and behavior settings
        const SHARED_VOICE_BIZ = {
            provider: '11labs',
            voiceId: 'EXAVITQu4vr4xnSDxMaL', // Bella — Business Hours
            stability: 0.55,
            similarityBoost: 0.8,
            style: 0.45,
            speed: 0.92,
            useSpeakerBoost: true,
            model: 'eleven_turbo_v2_5',
            chunkPlan: { enabled: true, minCharacters: 80 }
        };

        const SHARED_VOICE_AH = {
            provider: '11labs',
            voiceId: 'sarah', // Sarah — After Hours
            stability: 0.55,
            similarityBoost: 0.8,
            style: 0.45,
            speed: 0.92,
            useSpeakerBoost: true,
            model: 'eleven_turbo_v2_5',
            chunkPlan: { enabled: true, minCharacters: 80 }
        };

        const SHARED_TRANSCRIBER = {
            provider: '11labs',
            model: 'scribe_v2_realtime',
            language: 'en',
            silenceThresholdSeconds: 0.3
        };

        const SHARED_BEHAVIOR = {
            backgroundDenoisingEnabled: false,
            backgroundSpeechDenoisingPlan: {
                smartDenoisingPlan: { enabled: false },
                fourierDenoisingPlan: { enabled: false }
            },
            endCallFunctionEnabled: true,
            dialKeypadFunctionEnabled: true,
            serverUrl: `${N8N_BASE}/vapi-call-ended`,
            stopSpeakingPlan: {
                numWords: 3,
                voiceSeconds: 0.3,
                backoffSeconds: 1.0,
                acknowledgementPhrases: ['okay','got it','mm-hmm','uh-huh','right','sure','yep'],
                interruptionPhrases: ['wait','hold on','stop','actually','excuse me']
            },
            startSpeakingPlan: {
                waitSeconds: 1.2,
                smartEndpointingPlan: { provider: 'livekit' },
                transcriptionEndpointingPlan: {
                    onPunctuationSeconds: 0.6,
                    onNoPunctuationSeconds: 2.2,
                    onNumberSeconds: 1.5
                }
            },
            backchannelingEnabled: false,
            silenceTimeoutSeconds: 30
        };

        // ============================
        // TOOL DEFINITIONS
        // ============================
        const TOOL_SAVE_FIELD_BIZ = {
            type: 'function',
            function: {
                name: 'save_field',
                description: 'Save a collected data field from the caller to the system. Call this after collecting each piece of information.',
                parameters: {
                    type: 'object',
                    properties: {
                        call_id: { type: 'string', description: 'The unique call identifier' },
                        field_name: {
                            type: 'string',
                            enum: [
                                'caller_name','caller_phone','caller_email','caller_address','caller_dob',
                                'caller_occupation','policy_type','referral_source','claims_count','claims_details',
                                'urgency_timeline','current_coverage','shopping_reason',
                                'auto_vehicle_info','auto_vin','auto_lien_type','auto_lienholder',
                                'auto_violations','auto_household_drivers','auto_title_names',
                                'renter_address','renter_possessions_value','renter_mgmt_company','renter_addl_insured',
                                'property_address','property_first_buyer','property_value','property_coverage_needs','property_policy_age',
                                'biz_name','biz_ein','biz_start_date','biz_revenue','biz_industry','biz_contact',
                                'cross_sell_interest','cross_sell_types'
                            ]
                        },
                        field_value: { type: 'string', description: 'The value collected from the caller' }
                    },
                    required: ['call_id','field_name','field_value']
                }
            },
            server: { url: `${N8N_BASE}/vapi-save-field` }
        };

        const TOOL_SAVE_FIELD_AH = {
            type: 'function',
            function: {
                name: 'save_field',
                description: 'Save a collected data field to the system',
                parameters: {
                    type: 'object',
                    properties: {
                        call_id: { type: 'string' },
                        field_name: { type: 'string', enum: ['caller_name','caller_phone','reason_for_calling'] },
                        field_value: { type: 'string' }
                    },
                    required: ['call_id','field_name','field_value']
                }
            },
            server: { url: `${N8N_BASE}/vapi-save-field` }
        };

        const TOOL_CHECK_DISQUALIFIER = {
            type: 'function',
            function: {
                name: 'check_disqualifier',
                description: 'Check if the caller is disqualified based on claims history or coverage urgency. Call after collecting claims count and urgency timeline.',
                parameters: {
                    type: 'object',
                    properties: {
                        call_id: { type: 'string', description: 'The unique call identifier' },
                        claims_count_worst_year: { type: 'integer', description: 'The highest number of claims in any single year' },
                        urgency_hours: { type: 'integer', description: 'How many hours until coverage is needed' }
                    },
                    required: ['call_id','claims_count_worst_year','urgency_hours']
                }
            },
            server: { url: `${N8N_BASE}/vapi-check-disqualifier` }
        };

        const TOOL_CHECK_HOT_LEAD = {
            type: 'function',
            function: {
                name: 'check_hot_lead',
                description: 'Check if the caller qualifies as a high-value hot lead for immediate agent transfer. Call after collecting property value or auto value.',
                parameters: {
                    type: 'object',
                    properties: {
                        call_id: { type: 'string', description: 'The unique call identifier' },
                        policy_type: { type: 'string', description: 'The type of insurance policy' },
                        estimated_value: { type: 'number', description: 'The estimated property or auto value in dollars' }
                    },
                    required: ['call_id','policy_type','estimated_value']
                }
            },
            server: { url: `${N8N_BASE}/vapi-check-hotlead` }
        };

        const TOOL_ROUTE_EXISTING = {
            type: 'function',
            function: {
                name: 'route_existing_customer',
                description: 'Route an existing customer request. Creates a support ticket and notifies the team.',
                parameters: {
                    type: 'object',
                    properties: {
                        call_id: { type: 'string', description: 'The unique call identifier' },
                        caller_name: { type: 'string', description: 'The existing customer name' },
                        caller_phone: { type: 'string', description: 'The customer phone number' },
                        policy_type: { type: 'string', description: 'The type of policy they have or are asking about' },
                        request_description: { type: 'string', description: 'What the customer is asking for specifically' }
                    },
                    required: ['call_id','caller_name','caller_phone','request_description']
                }
            },
            server: { url: `${N8N_BASE}/vapi-existing-customer` }
        };

        const TOOL_ROUTE_CLAIM = {
            type: 'function',
            function: {
                name: 'route_claim',
                description: 'Route a claim call. Attempts to transfer to claims agent during business hours and sends priority notification.',
                parameters: {
                    type: 'object',
                    properties: {
                        call_id: { type: 'string', description: 'The unique call identifier' },
                        caller_name: { type: 'string', description: 'The caller name' },
                        caller_phone: { type: 'string', description: 'The caller phone number' },
                        policy_number: { type: 'string', description: 'The policy number if available' },
                        claim_type: { type: 'string', description: 'The type of claim (auto, property, etc.)' },
                        claim_description: { type: 'string', description: 'Description of the claim' }
                    },
                    required: ['call_id','caller_name','caller_phone','claim_type','claim_description']
                }
            },
            server: { url: `${N8N_BASE}/vapi-claim` }
        };

        const TOOL_ROUTE_CLAIM_AH = {
            type: 'function',
            function: {
                name: 'route_claim',
                description: 'Route an urgent claim to the claims team for priority handling',
                parameters: {
                    type: 'object',
                    properties: {
                        call_id: { type: 'string' },
                        caller_name: { type: 'string' },
                        caller_phone: { type: 'string' },
                        claim_type: { type: 'string', enum: ['Auto','Property','Business','Other'] },
                        claim_description: { type: 'string' }
                    },
                    required: ['call_id','caller_name','caller_phone','claim_type','claim_description']
                }
            },
            server: { url: `${N8N_BASE}/vapi-claim` }
        };

        // ============================
        // SYSTEM PROMPTS (from WF-01)
        // ============================
        const SYSTEM_PROMPT_BUSINESS = `You are the receptionist at Equity Insurance Inc., a 3rd-generation family-owned independent insurance agency in Honolulu, Hawaii. Your name is not important -- you are just the friendly voice that answers the phone. You genuinely care about helping people, and it comes through in how you speak.

WHO YOU ARE:
You sound like a real person who has worked at this office for years. You know the team, you know the business, and you like talking to people. You are warm but not over-the-top. You are helpful but you know your limits -- you are not a licensed agent. You collect information and schedule follow-ups with our human agents. Our core philosophy: We are always of service.

HOW YOU TALK -- THIS IS CRITICAL:
- Talk like a real person on the phone, not like you are reading from a screen. Vary your sentence length. Sometimes a short "Got it" is all you need. Other times you can say a full sentence.
- React to what people tell you BEFORE asking the next question. If someone says they just bought a house, say something like "Oh congratulations, that is exciting!" If they mention an accident, say "Oh no, I am sorry to hear that." If they have an unusual occupation, show brief interest. Be a human being first, data collector second.
- Do NOT use the same acknowledgment twice in a row. Mix it up: "Perfect." / "Great, thank you." / "Okay." / "Got it." / "Sounds good." / "Alright." / "Wonderful." Never say "Thank you for providing that" -- nobody talks like that.
- Keep responses to 1 to 3 sentences. A real receptionist does not give speeches. Ask ONE question at a time, then wait.
- Use contractions always. Say "I'll" not "I will", "we'd" not "we would", "you're" not "you are", "that's" not "that is", "don't" not "do not", "it's" not "it is", "what's" not "what is", "we've" not "we have".
- Use casual transitions, not formal ones. Say "And what's your email?" not "May I also have your email address please?" Say "Okay and the mailing address?" not "Could you please provide your mailing address?"
- Sometimes use sentence fragments. "Perfect, got that down." is better than "I have successfully recorded that information."
- If there is a pause or silence, do NOT immediately fill it. Wait a beat, then gently prompt: "Still there?" or "Take your time."
- If you mishear or the caller corrects you, be natural: "Oh sorry about that, let me fix that" or "My bad, let me update that."
- Match the caller's energy. If they are chatty, be a little more conversational. If they are in a hurry, be efficient and get through the questions faster.
- NEVER repeat the caller's answer back in a formal way like "So your name is John Smith, is that correct?" Instead say it casually: "John Smith -- did I get that right?" or just move on if it was clear.
- Do NOT say Aloha or Mahalo during the conversation. Those words are only for the greeting and closing. During the call, speak plain conversational English.

IMPORTANT RULES:
1. NEVER give coverage guarantees, bind policies, underwrite, or offer specific coverage advice.
2. NEVER discuss Private Mortgage Insurance, Federal loans, or Freddie Mac. Mortgage Protection is fine.
3. Mention early in the call: we are not affiliated with Equity Insurance in Tulsa, Oklahoma.
4. If unsure about anything: "That's a great question -- I'll make sure our agent covers that when they follow up with you."
5. We do NOT offer Pet Insurance or Travel Insurance.
6. We work with multiple carriers. A simple auto policy can sometimes be bound within an hour. More complex property coverage may take up to 3 business days.
7. Minimum premium is about $150 a year for basic renters.
8. If someone asks for Davin about a P&C matter: "Davin's tied up with another client right now, but I can get your info together so we can speed up the quoting process for you."
9. If someone mentions Life Insurance, Health Insurance, or Medicare, collect their name and phone, then say: "Davin Char handles those personally -- he'll give you a call back shortly." Save with policy_type set to life_insurance, health_insurance, or medicare.
10. The caller can press the pound key anytime to reach a live person.
11. Existing customers: ask what they need, get their name, phone, policy type, and a description, then call route_existing_customer.
12. Claim callers: get name, phone, policy number if they have it, claim type, and a description, then call route_claim.

WHEN TO TRANSFER IMMEDIATELY:
- Caller asks for someone specific by name.
- Caller has something complex that needs an agent.
- Caller is upset or complaining.
- Caller says they are ready to buy or bind coverage right now.
- Existing customer calling about a claim (use route_claim).

CALL FLOW:
Figure out what the caller needs:
A) New customer shopping for insurance -- go through data collection below.
B) Existing customer -- find out what they need, collect their info, call route_existing_customer.
C) Calling about a claim -- collect claim details, call route_claim.

If it is not clear, just ask naturally: "Are you looking for a new quote, or are you already a customer with us?"

DATA COLLECTION FOR NEW P&C CUSTOMERS:
Collect these in order, but make it feel like a conversation, not a checklist. Weave in natural transitions.

1. Full Name -- "Can I get your full name? And would you mind spelling the last name for me?"
2. Phone Number -- repeat it back casually to confirm.
3. Email -- "And what's a good email? We'll need that to send the quote over."
4. Mailing Address -- "Okay, and your mailing address?" Double-check spelling on street names.
5. Date of Birth.
6. Occupation -- "What do you do for work? Just asking because some occupations actually qualify for discounts."
7. Insurance Type -- Auto, Renters, Property, or Business. If they already mentioned it, confirm instead of asking again.
8. Referral Source -- "By the way, how'd you hear about us? We like to thank whoever sent you our way."
9. Shopping Reason -- "What made you start looking for new coverage?" Understand the story.
10. Current Coverage -- "Do you have insurance on this right now? If so, who are you with and roughly what are you paying?"
11. Claims History -- "Any claims in the past 5 years?" For EACH claim, ask what happened, what type, and the outcome.
12. Coverage Urgency -- "When do you need coverage to start?"

After collecting each piece, call the save_field function.

POLICY-SPECIFIC QUESTIONS:
For Auto: vehicle info, VIN if they have it, lease or loan, lienholder name, tickets or accidents past 5 years, all household drivers, multiple names on title, current auto policy and rate. Mention: "Progressive is one of our carriers and with a VIN we can sometimes get coverage going pretty quick."
For Renters: estimated value of possessions, property management company (additional insured), rental address.
For Property: first-time buyer, property value, address, claims past 5 years with details on each, urgency, current homeowners policy and how long they have had it.
For Business: business name, EIN, start date, annual gross revenue, industry and specific activity, best contact.

QUALIFICATION CHECKS:
After claims and urgency, call check_disqualifier. If disqualified (3+ claims in worst year or coverage needed within 72 hours), be kind about it.

After property or auto value, call check_hot_lead. If hot lead (property over $2M or auto over $180K), connect them with an agent right away.

CROSS-SELL:
After everything is collected and the lead qualifies, naturally offer ONE related coverage.

ENDING THE CALL:
You can end the call after the caller says goodbye. Always wait for the caller to say goodbye first.

CLOSING:
Briefly recap what you collected and confirm. Then close warmly: "Mahalo for calling Equity Insurance! Val's going to look over everything and get back to you with your quote. We're always happy to help. Have a great day!"`;

        const SYSTEM_PROMPT_AFTERHOURS = `You are the after-hours receptionist at Equity Insurance Inc., a 3rd-generation family-owned insurance agency in Honolulu, Hawaii. The office is closed right now -- business hours are 9 AM to 5 PM Hawaii time, Monday through Friday.

Be warm and brief. You are just here to take a quick message so someone can call them back.

HOW YOU TALK:
- Sound like a real person, not a robot. Use contractions. Keep it short.
- Vary your acknowledgments. Don't say the same thing twice.
- React naturally to what people say.
- 1 to 2 sentences max per response.

Collect only:
1. Full Name -- ask them to spell it.
2. Phone Number -- repeat it back to confirm.
3. Reason for calling -- brief description of what they need.

If they have an urgent claim or emergency, collect the details (name, phone, claim type, description) and call route_claim to trigger a priority alert to our team.

RULES:
- Never give coverage advice or make promises.
- We are not affiliated with Equity Insurance in Tulsa, Oklahoma.
- We don't offer Pet Insurance or Travel Insurance.
- If unsure: "Great question -- our team will cover that when they follow up with you."

After collecting info, call save_field for each piece. Then close: "Mahalo for calling Equity Insurance! Someone from our team will get back to you on the next business day. Have a good evening!" Then wait for them to say goodbye, and end the call.

ENDING THE CALL:
You can end the call. Do it after the caller says goodbye or any farewell. Always let them say bye first -- don't hang up abruptly.`;

        // ============================
        // INLINE ASSISTANT CONFIGS (matches WF-01 exactly)
        // ============================
        function getAssistantConfig(mode) {
            const isBiz = mode === 'business';
            const tools = isBiz
                ? [TOOL_SAVE_FIELD_BIZ, TOOL_CHECK_DISQUALIFIER, TOOL_CHECK_HOT_LEAD, TOOL_ROUTE_EXISTING, TOOL_ROUTE_CLAIM]
                : [TOOL_SAVE_FIELD_AH, TOOL_ROUTE_CLAIM_AH];
            return {
                firstMessage: isBiz
                    ? "Aloha, thank you for calling Equity Insurance in Honolulu, Hawaii -- not affiliated with Equity Insurance in Tulsa, Oklahoma. How can I help you today?"
                    : "Aloha, thank you for calling Equity Insurance in Honolulu, Hawaii. We are currently closed -- our business hours are 9 AM to 5 PM Hawaii time, Monday through Friday. I can take a message and have someone call you back. May I have your name?",
                model: {
                    provider: 'openai',
                    model: 'gpt-4o',
                    temperature: 0.5,
                    maxTokens: 300,
                    messages: [{ role: 'system', content: isBiz ? SYSTEM_PROMPT_BUSINESS : SYSTEM_PROMPT_AFTERHOURS }],
                    tools: tools
                },
                voice: isBiz ? SHARED_VOICE_BIZ : SHARED_VOICE_AH,
                transcriber: SHARED_TRANSCRIBER,
                ...SHARED_BEHAVIOR
            };
        }

        // ============================
        // STATE & LOGIC
        // ============================
        let vapi = null;
        let callActive = false;
        let isMuted = false;
        let currentMode = 'business';
        let durationInterval = null;
        let callStartTime = null;

        function activateCall() {
            if (callActive) return; // already activated
            callActive = true;
            callStartTime = Date.now();
            startDurationTimer();
            updateUI('active');
            updateCallStage('idle');
            logSystem('Call connection established.');

            // Ensure mic is unmuted when call starts
            isMuted = false;
            if (vapi) {
                try { vapi.setMuted(false); } catch (e) {}
            }
            const muteBtn2 = document.getElementById('muteBtn');
            if (muteBtn2) {
                muteBtn2.classList.remove('bg-danger', 'text-white', 'border-transparent');
                muteBtn2.classList.add('glass', 'text-zinc-400');
                const muteIcon2 = muteBtn2.querySelector('i') || muteBtn2.querySelector('svg');
                if (muteIcon2) muteIcon2.setAttribute('data-lucide', 'mic');
            }

            // Visuals
            document.getElementById('ambient-glow').classList.remove('opacity-0');
            document.getElementById('ring-1').classList.remove('opacity-0');
            document.getElementById('ring-2').classList.remove('opacity-0');
            document.getElementById('circle-visualizer').classList.remove('opacity-0');
            const micIcon = document.getElementById('main-mic-icon');
            if (micIcon) {
                micIcon.classList.add('text-primary');
                micIcon.classList.remove('text-zinc-500');
            }
            // Show mic level bar
            const micBar = document.getElementById('mic-level-bar');
            if (micBar) micBar.classList.remove('opacity-0');
        }

        function deactivateCall() {
            callActive = false;
            stopDurationTimer();
            updateUI('ended');
            logSystem('Call terminated.');
            document.getElementById('typing-indicator').classList.add('hidden');
            updateCallStage('complete');

            // Visuals
            document.getElementById('ambient-glow').classList.add('opacity-0');
            document.getElementById('ring-1').classList.add('opacity-0');
            document.getElementById('ring-2').classList.add('opacity-0');
            document.getElementById('circle-visualizer').classList.add('opacity-0');
            const micIcon = document.getElementById('main-mic-icon');
            if (micIcon) {
                micIcon.classList.remove('text-primary');
                micIcon.classList.add('text-zinc-500');
            }
            // Hide mic level bar and partial transcript
            const micBar = document.getElementById('mic-level-bar');
            if (micBar) { micBar.classList.add('opacity-0'); }
            const partialEl = document.getElementById('partial-transcript');
            if (partialEl) { partialEl.textContent = ''; partialEl.classList.add('hidden'); }
        }

        function initVapi() {
            vapi = new Vapi(VAPI_PUBLIC_KEY);

            // Listen for both old and new event names
            vapi.on('call-start', activateCall);
            vapi.on('call-started', activateCall);

            vapi.on('call-end', deactivateCall);
            vapi.on('call-ended', deactivateCall);

            vapi.on('speech-start', () => {
                activateCall(); // fallback: if call-start never fired, activate on first speech
                document.getElementById('typing-indicator').classList.remove('hidden');
                updateConnectionStatus('AI Speaking', 'text-primary', 'bg-primary');
                // Dim mic level when AI is speaking
                const micBar = document.getElementById('mic-level-bar');
                if (micBar) micBar.style.opacity = '0.3';
            });

            vapi.on('speech-end', () => {
                document.getElementById('typing-indicator').classList.add('hidden');
                updateConnectionStatus('Listening', 'text-success', 'bg-success');
                // Restore mic level visibility when AI stops
                const micBar = document.getElementById('mic-level-bar');
                if (micBar) micBar.style.opacity = '1';
            });

            // Mic volume level — animate the circle visualizer bars to show mic is active
            vapi.on('volume-level', (level) => {
                const bars = document.querySelectorAll('#circle-visualizer > div');
                const micBar = document.getElementById('mic-level-fill');
                if (micBar) {
                    micBar.style.width = Math.min(level * 200, 100) + '%';
                    micBar.style.backgroundColor = level > 0.05 ? '#22c55e' : '#71717a';
                }
                if (bars.length && callActive) {
                    const h = [8, 12, 6]; // base heights in tailwind units
                    bars.forEach((bar, i) => {
                        const boost = level * 40;
                        bar.style.height = (h[i] + boost * (0.8 + Math.random() * 0.4)) + 'px';
                    });
                }
            });

            vapi.on('message', (message) => {
                activateCall(); // fallback: activate on first message of any kind

                // Show partial transcripts (real-time) so user can see their voice is being heard
                if (message.type === 'transcript' && message.transcriptType === 'partial') {
                    const partialEl = document.getElementById('partial-transcript');
                    if (partialEl && message.role === 'user') {
                        partialEl.textContent = message.transcript;
                        partialEl.classList.remove('hidden');
                    }
                }

                if (message.type === 'transcript' && message.transcriptType === 'final') {
                    // Clear partial transcript
                    const partialEl = document.getElementById('partial-transcript');
                    if (partialEl) {
                        partialEl.textContent = '';
                        partialEl.classList.add('hidden');
                    }
                    addTranscriptMessage(message.role, message.transcript);
                }
                if (message.type === 'function-call') {
                    handleFunctionCall(message.functionCall);
                }
                if (message.type === 'tool-calls' && message.toolCalls) {
                    message.toolCalls.forEach(tc => {
                        if(tc.function) handleFunctionCall(tc.function);
                    });
                }
                // Handle tool-call results from n8n webhooks
                if (message.type === 'tool-calls-result' && message.toolCallResult) {
                    handleToolCallResult(message.toolCallResult.id, message.toolCallResult.result);
                }
                if (message.type === 'function-call-result' || message.type === 'tool-call-result') {
                    const result = message.result || message.functionCallResult?.result || '';
                    handleToolCallResult(message.toolCallId || '', result);
                }
            });

            vapi.on('error', (error) => {
                console.error('VAPI Error (full):', JSON.stringify(error, null, 2));
                let errMsg;
                try {
                    const inner = error?.error?.error || error?.error || error;
                    errMsg = typeof inner?.message === 'string' ? inner.message
                           : typeof inner?.message === 'object' ? JSON.stringify(inner.message)
                           : JSON.stringify(inner);
                } catch(e) {
                    errMsg = String(error);
                }
                const errStatus = error?.error?.statusCode || error?.statusCode || '';

                // Krisp/audio processor errors are non-fatal — suppress and continue
                const isKrisp = errMsg?.includes('Krisp') || errMsg?.includes('krisp')
                    || errMsg?.includes('SAMPLE_RATE') || errMsg?.includes('mic processor');
                if (isKrisp) {
                    console.warn('Non-fatal Krisp/audio warning (suppressed):', errMsg);
                    logSystem(`<span class="text-amber-400">AUDIO</span> Noise filter unavailable (non-fatal) — call continues`);
                    return;
                }

                // Daily.co ejection — log details but don't double-reset if call already ended
                const isEjection = errMsg?.includes('ejected') || errMsg?.includes('Meeting has ended');
                if (isEjection) {
                    logSystem(`<span class="text-red-400">EJECTED</span> Daily.co session ended — type: ${error?.type}, action: ${error?.error?.action}`);
                    if (callActive) deactivateCall();
                    else updateUI('error');
                    return;
                }

                // Only reset UI for fatal errors (API 400, start failures)
                const isFatal = error?.type === 'start-method-error'
                    || errStatus >= 400
                    || errMsg?.includes('start')
                    || errMsg?.includes('unauthorized');
                if (isFatal && !callActive) {
                    updateUI('error');
                }
                logSystem(`${isFatal ? 'FATAL' : 'Warning'}: ${errMsg}`);
            });
        }

        function handleFunctionCall(fn) {
            const args = (() => {
                try { return typeof fn.arguments === 'string' ? JSON.parse(fn.arguments) : (fn.arguments || {}); }
                catch(e) { console.error('Error parsing args for', fn.name, e); return {}; }
            })();

            switch (fn.name) {
                case 'save_field':
                    logSystem(`<span class="text-blue-400">SAVE</span> ${args.field_name} = "${args.field_value}"`);
                    updateDataTable(args.field_name, args.field_value);
                    updateCallStage('collecting');
                    break;

                case 'check_disqualifier':
                    logSystem(`<span class="text-amber-400">RULE CHECK</span> Disqualifier evaluation triggered`);
                    updateStatusBadge('disqualifier', 'checking', 'Evaluating...');
                    updateCallStage('evaluating');
                    break;

                case 'check_hot_lead':
                    logSystem(`<span class="text-amber-400">RULE CHECK</span> Hot lead evaluation triggered`);
                    updateStatusBadge('hotlead', 'checking', 'Evaluating...');
                    updateCallStage('evaluating');
                    break;

                case 'route_existing_customer':
                    logSystem(`<span class="text-purple-400">ROUTE</span> Existing customer → Ticket + Val notification`);
                    updateStatusBadge('calltype', 'info', 'Existing Customer');
                    updateCallStage('routing');
                    break;

                case 'route_claim':
                    logSystem(`<span class="text-red-400">ROUTE</span> Claim filed → Priority notification sent`);
                    updateStatusBadge('calltype', 'urgent', 'Claim Filed');
                    updateCallStage('routing');
                    break;

                default:
                    logSystem(`Function: ${fn.name}`);
            }
        }

        function updateDataTable(key, value) {
            const tbody = document.getElementById('data-table-body');
            // Remove empty state
            if (tbody.querySelector('td[colspan="2"]')) {
                tbody.innerHTML = '';
            }

            let row = document.getElementById(`row-${key}`);
            if (!row) {
                row = document.createElement('tr');
                row.id = `row-${key}`;
                row.className = 'border-b border-white/5 hover:bg-white/5 transition-colors animate-slide-up';
                row.innerHTML = `
                    <td class="px-6 py-3 font-mono text-xs text-zinc-500">${key}</td>
                    <td class="px-6 py-3 text-sm text-zinc-200 font-medium" id="val-${key}"></td>
                `;
                tbody.appendChild(row);
            }
            
            const valCell = row.querySelector(`#val-${key}`);
            valCell.textContent = value;
            valCell.classList.add('text-accent');
            setTimeout(() => valCell.classList.remove('text-accent'), 1500);

            // Update field counter — core fields are 8, but policy-specific fields may add more
            const rows = tbody.querySelectorAll('tr');
            const total = currentMode === 'business' ? 12 : 3;
            document.getElementById('field-count').textContent = `${rows.length} / ${total}+`;
        }

        let fieldCount = 0;
        const stageOrder = ['idle', 'collecting', 'evaluating', 'routing', 'complete'];

        function updateCallStage(stage) {
            const idx = stageOrder.indexOf(stage);
            stageOrder.forEach((s, i) => {
                const el = document.getElementById(`stage-${s}`);
                if (!el) return;
                if (i < idx) {
                    el.className = 'w-full h-1.5 rounded-full bg-success transition-all duration-500';
                } else if (i === idx) {
                    el.className = 'w-full h-1.5 rounded-full bg-primary animate-pulse transition-all duration-500';
                } else {
                    el.className = 'w-full h-1.5 rounded-full bg-zinc-700 transition-all duration-500';
                }
            });
        }

        function updateStatusBadge(type, status, text) {
            const container = document.getElementById('status-badges');
            const badge = document.getElementById(`badge-${type}`);
            const label = document.getElementById(`badge-${type}-text`);
            if (!badge || !label) return;

            container.classList.remove('hidden');
            badge.classList.remove('hidden');
            label.textContent = text;

            // Reset classes
            badge.className = 'flex items-center gap-2 px-3 py-1.5 rounded-lg border';
            const icon = badge.querySelector('svg, i');

            switch (status) {
                case 'checking':
                    badge.classList.add('bg-amber-500/10', 'border-amber-500/20');
                    label.classList.add('text-amber-400');
                    if (icon) icon.classList.add('text-amber-400');
                    break;
                case 'pass':
                    badge.classList.add('bg-emerald-500/10', 'border-emerald-500/20');
                    label.classList.add('text-emerald-400');
                    if (icon) icon.classList.add('text-emerald-400');
                    break;
                case 'fail':
                    badge.classList.add('bg-red-500/10', 'border-red-500/20');
                    label.classList.add('text-red-400');
                    if (icon) icon.classList.add('text-red-400');
                    break;
                case 'hot':
                    badge.classList.add('bg-orange-500/10', 'border-orange-500/20');
                    label.classList.add('text-orange-400');
                    if (icon) icon.classList.add('text-orange-400');
                    break;
                case 'info':
                    badge.classList.add('bg-purple-500/10', 'border-purple-500/20');
                    label.classList.add('text-purple-400');
                    if (icon) icon.classList.add('text-purple-400');
                    break;
                case 'urgent':
                    badge.classList.add('bg-red-500/10', 'border-red-500/20');
                    label.classList.add('text-red-400');
                    if (icon) icon.classList.add('text-red-400');
                    break;
                default:
                    badge.classList.add('bg-surface', 'border-white/5');
            }
            lucide.createIcons();
        }

        function handleToolCallResult(toolCallId, result) {
            // Parse result text to update status badges
            const r = (result || '').toLowerCase();
            if (r.includes('not disqualified') || r.includes('qualifies')) {
                updateStatusBadge('disqualifier', 'pass', 'Qualified');
                logSystem('<span class="text-emerald-400">PASS</span> Caller qualifies — no disqualifiers');
            } else if (r.includes('disqualified')) {
                updateStatusBadge('disqualifier', 'fail', 'Disqualified');
                logSystem('<span class="text-red-400">FAIL</span> Caller disqualified');
            }
            if (r.includes('hot lead') || r.includes('high value') || r.includes('transfer')) {
                updateStatusBadge('hotlead', 'hot', 'HOT LEAD — Transfer');
                logSystem('<span class="text-orange-400">HOT LEAD</span> High-value — transferring to agent');
                updateCallStage('routing');
            } else if (r.includes('not a hot lead') || r.includes('standard') || r.includes('not hot')) {
                updateStatusBadge('hotlead', 'pass', 'Standard Lead');
                logSystem('<span class="text-emerald-400">PASS</span> Standard lead — continue intake');
            }
            if (r.includes('ticket created') || r.includes('notification sent')) {
                updateCallStage('complete');
                logSystem('<span class="text-emerald-400">DONE</span> Workflow actions completed');
            }
        }

        async function toggleCall() {
            if (callActive) {
                logSystem('Ending call...');
                try {
                    vapi.stop();
                } catch (err) {
                    console.error('Error stopping call:', err);
                }
                // Force UI reset in case call-end event doesn't fire
                setTimeout(() => {
                    if (callActive) {
                        logSystem('Force-ending call (event timeout).');
                        deactivateCall();
                    }
                }, 3000);
            } else {
                updateUI('connecting');
                try {
                    const config = getAssistantConfig(currentMode);
                    logSystem(`Initializing call (${currentMode} mode, inline config, voice: ${config.voice.voiceId})...`);
                    await vapi.start(config);
                } catch (err) {
                    updateUI('error');
                    console.error('Start call error (full):', JSON.stringify(err, null, 2));
                    let detail;
                    try {
                        const inner = err?.error?.error || err?.error || err;
                        detail = typeof inner?.message === 'string' ? inner.message
                               : typeof inner?.message === 'object' ? JSON.stringify(inner.message)
                               : err?.message || JSON.stringify(err);
                    } catch(e) {
                        detail = String(err);
                    }
                    logSystem('Failed to start: ' + detail);
                }
            }
        }

        function toggleMute() {
            if (!callActive) return;
            isMuted = !isMuted;
            vapi.setMuted(isMuted);
            const btn = document.getElementById('muteBtn');
            const icon = btn.querySelector('i') || btn.querySelector('svg');

            if (isMuted) {
                btn.classList.add('bg-danger', 'text-white', 'border-transparent');
                btn.classList.remove('glass', 'text-zinc-400');
                if (icon) icon.setAttribute('data-lucide', 'mic-off');
            } else {
                btn.classList.remove('bg-danger', 'text-white', 'border-transparent');
                btn.classList.add('glass', 'text-zinc-400');
                if (icon) icon.setAttribute('data-lucide', 'mic');
            }
            lucide.createIcons();
        }

        function setMode(mode) {
            if (callActive) return;
            currentMode = mode;
            const bizBtn = document.getElementById('mode-biz');
            const ahBtn = document.getElementById('mode-ah');
            
            if (mode === 'business') {
                bizBtn.className = 'px-4 py-2 rounded-md text-xs font-semibold transition-all duration-200 bg-primary text-white shadow-lg shadow-primary/25';
                ahBtn.className = 'px-4 py-2 rounded-md text-xs font-semibold transition-all duration-200 text-zinc-400 hover:text-white hover:bg-white/5';
            } else {
                ahBtn.className = 'px-4 py-2 rounded-md text-xs font-semibold transition-all duration-200 bg-primary text-white shadow-lg shadow-primary/25';
                bizBtn.className = 'px-4 py-2 rounded-md text-xs font-semibold transition-all duration-200 text-zinc-400 hover:text-white hover:bg-white/5';
            }
        }

        function updateUI(state) {
            const btn = document.getElementById('callBtn');
            const muteBtn = document.getElementById('muteBtn');
            const statusText = document.getElementById('call-state-text');
            // Lucide replaces <i> with <svg>, so check both
            const btnIcon = btn.querySelector('i') || btn.querySelector('svg');

            switch (state) {
                case 'connecting':
                    btn.disabled = true;
                    btn.classList.add('opacity-75');
                    statusText.textContent = 'Connecting...';
                    updateConnectionStatus('Connecting', 'text-accent', 'bg-accent');
                    break;
                case 'active':
                    btn.disabled = false;
                    btn.classList.remove('opacity-75', 'bg-white', 'text-black');
                    btn.classList.add('bg-danger', 'text-white', 'shadow-danger/40');
                    if (btnIcon) btnIcon.setAttribute('data-lucide', 'phone-off');
                    statusText.textContent = 'Live Call';
                    muteBtn.disabled = false;
                    updateConnectionStatus('Connected', 'text-success', 'bg-success');
                    break;
                case 'ended':
                case 'error':
                    btn.disabled = false;
                    btn.classList.remove('opacity-75', 'bg-danger', 'text-white', 'shadow-danger/40');
                    btn.classList.add('bg-white', 'text-black');
                    if (btnIcon) btnIcon.setAttribute('data-lucide', 'phone');
                    statusText.textContent = state === 'error' ? 'Connection Failed' : 'Call Ended';
                    muteBtn.disabled = true;
                    updateConnectionStatus('Disconnected', 'text-zinc-400', 'bg-zinc-500');
                    break;
            }
            lucide.createIcons();
        }

        function updateConnectionStatus(text, textColor, dotColor) {
            const statusEl = document.getElementById('connection-status');
            const dotEl = document.getElementById('status-dot');
            const pingEl = document.getElementById('status-ping');
            
            statusEl.textContent = text;
            statusEl.className = `text-xs font-semibold uppercase tracking-wide ${textColor}`;
            
            dotEl.className = `relative w-2.5 h-2.5 rounded-full ${dotColor} transition-colors duration-300`;
            pingEl.className = `status-dot-pulse ${dotColor} ${text === 'Disconnected' ? 'hidden' : 'block'}`;
        }

        function addTranscriptMessage(role, text) {
            const container = document.getElementById('transcript');
            // Remove empty state
            if (container.querySelector('.text-zinc-600')) {
                container.innerHTML = '';
            }

            const isAi = role === 'assistant';
            const div = document.createElement('div');
            div.className = `flex ${isAi ? 'justify-start' : 'justify-end'} animate-slide-up`;
            
            div.innerHTML = `
                <div class="max-w-[85%] ${isAi ? 'bg-surfaceHighlight border border-white/5 text-zinc-200' : 'bg-primary text-white shadow-lg shadow-primary/20'} rounded-2xl px-5 py-3.5 text-sm leading-relaxed">
                    ${text}
                </div>
            `;
            
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function clearTranscript() {
            document.getElementById('transcript').innerHTML = `
                <div class="h-full flex flex-col items-center justify-center text-zinc-600 gap-4 opacity-50">
                    <i data-lucide="bot" class="w-12 h-12 stroke-1"></i>
                    <p class="text-sm font-medium">Waiting for call to start...</p>
                </div>
            `;
        }

        function logSystem(text) {
            const container = document.getElementById('system-logs');
            const div = document.createElement('div');
            const time = new Date().toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
            div.className = 'text-zinc-500 hover:text-zinc-300 transition-colors';
            div.innerHTML = `<span class="text-zinc-700 mr-2">[${time}]</span>${text}`;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function startDurationTimer() {
            stopDurationTimer();
            durationInterval = setInterval(() => {
                if (!callStartTime) return;
                const elapsed = Math.floor((Date.now() - callStartTime) / 1000);
                const min = String(Math.floor(elapsed / 60)).padStart(2, '0');
                const sec = String(elapsed % 60).padStart(2, '0');
                document.getElementById('timer').textContent = min + ':' + sec;
            }, 1000);
        }

        function stopDurationTimer() {
            if (durationInterval) {
                clearInterval(durationInterval);
                durationInterval = null;
            }
        }

        // ============================
        // FIX: Force mic to 48kHz max to prevent Krisp crash on high-sample-rate mics (192kHz)
        // Krisp only supports up to 48kHz. Daily.co's WebRTC layer initializes Krisp
        // before VAPI assistant config is applied, so we intercept getUserMedia globally.
        // IMPORTANT: Preserve all default audio processing (echo cancel, noise suppression, gain)
        // ============================
        (function patchGetUserMedia() {
            const original = navigator.mediaDevices.getUserMedia.bind(navigator.mediaDevices);
            navigator.mediaDevices.getUserMedia = async function(constraints) {
                if (constraints && constraints.audio) {
                    if (typeof constraints.audio === 'boolean') {
                        constraints.audio = {
                            sampleRate: { ideal: 48000, max: 48000 },
                            echoCancellation: true,
                            noiseSuppression: true,
                            autoGainControl: true
                        };
                    } else if (typeof constraints.audio === 'object') {
                        constraints.audio.sampleRate = { ideal: 48000, max: 48000 };
                        if (constraints.audio.echoCancellation === undefined) constraints.audio.echoCancellation = true;
                        if (constraints.audio.noiseSuppression === undefined) constraints.audio.noiseSuppression = true;
                        if (constraints.audio.autoGainControl === undefined) constraints.audio.autoGainControl = true;
                    }
                    console.log('[MIC] getUserMedia audio constraints:', JSON.stringify(constraints.audio));
                }
                return original(constraints);
            };
        })();

        // Suppress uncaught Krisp promise rejections as a safety net
        window.addEventListener('unhandledrejection', (event) => {
            const msg = String(event.reason?.message || event.reason || '');
            if (msg.includes('Krisp') || msg.includes('krisp') || msg.includes('SAMPLE_RATE')) {
                event.preventDefault();
                console.warn('Suppressed Krisp error:', msg);
            }
        });

        // Boot — dynamically import VAPI Web SDK (ES module)
        async function boot() {
            try {
                const module = await import('https://cdn.jsdelivr.net/npm/@vapi-ai/web@latest/+esm');
                // The SDK may export as default, default.default, or named Vapi
                const VapiClass = module.default?.default || module.default || module.Vapi;
                if (!VapiClass || typeof VapiClass !== 'function') {
                    console.log('Module exports:', Object.keys(module), 'default type:', typeof module.default);
                    throw new Error('Could not find Vapi constructor in module');
                }
                window.Vapi = VapiClass;
                logSystem('VAPI SDK loaded successfully.');
                initVapi();
            } catch (err) {
                console.error('Failed to load VAPI SDK:', err);
                logSystem('ERROR: Failed to load VAPI SDK — ' + err.message);
            }
        }
        boot();
    </script>
</body>
</html>